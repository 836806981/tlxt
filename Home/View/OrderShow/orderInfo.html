<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>[田螺阿姨]后台</title>

</head>

<body>
			<!--top-->

			<include  file="Nav/header"/>
			<!--left end-->
			<script>
				$('.left_menu li').eq(3).addClass('called');
			</script>
			<!--main-->
			<div class="col-md-10 main">
				<div class="tab_tle">
					<span class="int_s"></span>订单详情
				</div>
				<div class="filesInfo form">
					<div class="form-group">
						 <label>客户姓名：</label><span class="w_555"><a href="__MODULE__/Order/clientFile/id/{$info.id}">{$info.name}</a></span>
					</div>
					<div class="form-group">
						 <label>类<i></i><i></i>型：</label><span class="w_555">{$info.other}</span>
					</div>
					<div class="form-group">
						<label>状<i></i><i></i>态：</label><span class="w_555">{$info.status_name}</span>
					</div>
					<div class="form-group">
						 <label>联系方式：</label><span class="w_555">{$info.phone}</span>
					</div>

					<div class="form-group">
						<label>合同金额：</label><span class="w_555">{$info.contract_money}</span>
					</div>


					<div class="form-group">
						<label>阿姨工资：</label><span class="w_555">{$info.nurse_pay}</span>
					</div>


					<div class="form-group">
						<label>联系方式：</label><span class="w_555">{$info.phone}</span>
					</div>


					<div class="form-group">
						 <label>服务人员：</label><span class="w_555">
								<volist name="order_nurse" id="vo">
									<a href="__MODULE__/Nurse/nurseInfo/id/{$vo.nurse_id}">{$vo.nurse_name} ({$vo.nurse_pay}/{$vo.nurse_pay_true})</a> |
								</volist>

						 	<i class="ayi"><a href="__MODULE__/Nurse/nurseInfo/id/{$info.nurse_id}">{$nurse.name}</a>（{$nurse.status_sh_name}）</i>

						<if condition="$info.status lt 4">
							<a onclick="addayi()">售后</a>
						</if>


						 </span>

					</div>
					<div class="form-group">
						 <label>预计上户：</label><span class="w_240">{$info.b_time}</span>
						 <label>实际上户：</label><span class="w_240">{$info.true_b_time}</span>
					</div>
					<div class="form-group">
						 <label>预计下户：</label><span class="w_240">{$info.s_time}</span>
						 <label>实际下户：</label><span class="w_240">{$info.true_s_time}</span>
					</div>
				</div>
				<div class="form-group" style="margin-left: 19px;">


					<if condition="$info.status eq 2">
						<if condition="$nurse.status_sh eq 2">
							<button type="button" class="btnform magrin0" onclick="upOrder()">上户</button>
							<else />
							阿姨未下户，不能执行上户操作
						</if>
					</if>

					<if condition="$info.status eq 3">
							<button type="button" class="btnform magrin0" onclick="downOrder()">下户</button>
					</if>


					<button type="button" class="btnform magrin0" onclick="location.href='__MODULE__/OrderShow/changeOrder/id/{$info.id}.html'">修改订单</button>
					<button type="button" class="default_btn" onclick="javascript:history.back(-1);">返回</button>
				</div>
				
			</div>

			<script>
				var reg=/^(?:(?!0000)[0-9]{4}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-8])|(?:0[13-9]|1[0-2])-(?:29|30)|(?:0[13578]|1[02])-31)|(?:[0-9]{2}(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)-02-29)$/;
				var a= /^[0-9]*(\.[0-9]{1,2})?$/;
				var b= /~\d$/;
				//售后
				function addayi(){

					var submit = "javascript:return window.confirm('确定售后订单么？')";
					layer.open({
						type: 1,
						title: '售后',
						area: ['auto', 'auto'], //宽高
						content: '<div class="lay_cnt">'
						+   '<form action="__MODULE__/OrderShow/make_order" method="post" id="form_make_order" class="form" onsubmit="'+submit+'"  enctype="multipart/form-data">'
						+	'<h5>上一个阿姨</h5>'
						+	'<div class="opn_div clear">'
						+		'<label>阿姨姓名：</label><input type="text" class="form-control" value="{$nurse.name}" id="old_nurse_name" name="old_nurse_name" readonly/>'
						+              '<input type="hidden"  value="{$info.id}" id="id" name="id"/>'
						+	'</div>'
						+	'<div class="opn_div clear">'
						+		'<label>下户日期：</label><input type="text" class="form-control" value=""  id="true_s_time" name="true_s_time" placeholder="2016-01-01"/>'
						+	'</div>'
						+	'<div class="opn_div clear">'
						+		'<label>上单时长：</label><input type="number" class="form-control" value=""  id="do_time" name="do_time"/>'
						+	'</div>'
						+	'<div class="opn_div clear">'
						+		'<label>阿姨工资：</label><input type="text" class="form-control" value="{$info.nurse_pay}" name="old_nurse_pay" id="old_nurse_pay"/>'
						+	'</div>'
						+	'<h5>下一个阿姨</h5>'
						+	'<div class="opn_div clear">'
						+		'<label>阿姨编号：</label><input type="text" class="form-control" value="" style="width: 60%;"  name="nurse_number" id="nurse_number"/> <button type="button" style="vertical-align: middle;float:right;" class="check_number btnform magrin0">核查</button>'
						+	'</div>'
						+	'<div class="opn_div clear">'
						+		'<label>阿姨姓名：</label><input type="text" class="form-control" value="" name="nurse_name" id="nurse_name" readonly/><input type="hidden" value="" name="nurse_id" id="nurse_id"/>'
						+	'</div>'
						+	'<div class="opn_div clear">'
						+		'<label>阿姨工资：</label><input type="text" class="form-control" value="" name="nurse_pay" id="nurse_pay" readonly/>'
						+	'</div>'
						+	'<div class="opn_div clear">'
						+		'<label>保险时长：</label>'
						+		'<select class="form-control" name="safe_time" id="safe_time">'
						+     		'<option>1个月</option>'
						+     		'<option>2个月</option>'
						+     		'<option>3个月</option>'
						+     		'<option>4个月</option>'
						+     		'<option>5个月</option>'
						+     		'<option>6个月</option>'
						+     		'<option>7个月</option>'
						+     		'<option>8个月</option>'
						+     		'<option>9个月</option>'
						+     		'<option>10个月</option>'
						+     		'<option>11个月</option>'
						+     		'<option>12个月</option>'
						+ 		'</select>'
						+	'</div>'
						+	'<div class="opn_div clear">'
						+		'<label>预计上户：</label><input type="text" class="form-control" value="" name="b_time" id="b_time"  placeholder="2016-01-01"/>'
						+	'</div>'
						+	'<div class="opn_div clear">'
						+		'<label>预计下户：</label><input type="text" class="form-control" value="" name="s_time" id="s_time"  placeholder="2016-01-01"/>'
						+	'</div>'
						+	'<div class="btn_div clear">'
						+		'<button type="button" class="default_btn" id="make_order">售后</button>'
						+		'<button type="button" class="default_btn" onclick="close_lay()">取消</button>'
						+	'</div>'
						+	'</form>'
						+'</div>'
					});
				}
				function close_lay(){
					layer.closeAll();
				}

				$('#do_time').live('change',function(){
					var id = $('#id').val();
					var do_time = $(this).val();
					$.AjaxPost(MODULE+"/orderShow/getNursePay", {id:id,do_time:do_time}, function (backdata) {
						if (backdata.code == 1001) {
							layer.msg('参数错误！');
						}else if (backdata.code == 1000) {
							$('#old_nurse_pay').val(backdata.price);
						}
					});
				});

				//核查阿姨
				$('.check_number').live('click',function(){
					var nurse_number = $(this).parent().find('input').val();
					$.AjaxPost(MODULE+"/order/getNurseInfo", {number:nurse_number}, function (backdata) {
						if (backdata.code == 1003) {
							layer.msg('请输入编号！');
						}else if (backdata.code == 1002) {
							layer.msg('未找到阿姨！');
						}else if (backdata.code == 1000) {
							if(backdata.data.id == $('#old_nurse_id').val()){
								layer.msg('已签该阿姨！');
								$('#nurse_number').val('');
							}else{
								layer.msg('成功！');
								backdata.data.number;
								$('#nurse_name').val(backdata.data.name);
								$('#nurse_id').val(backdata.data.id);
								$('#nurse_pay').val(backdata.data.level_price);
							}
						}
					});
				});

				$('#make_order').live('click',function(){
					if(!a.test($('#old_nurse_pay').val()) || $('#old_nurse_pay').val()=='') {
						layer.msg('请输入正确的下户阿姨工资！');
						return false;

					}
					if(!reg.test($('#true_s_time').val())  ||  !reg.test($('#true_s_time').val())){
						layer.msg('请输入正确的下户时间！');
						return false;
					}
					if($('#do_time').val()=='' ){
						layer.msg('请输入正确的阿姨上户时长！');
						return false;
					}
					if($('#nurse_number').val()==''||$('#nurse_name').val()==''||$('#nurse_id').val()==''){
						layer.msg('请核查阿姨编号及姓名！');
						return false;
					}

					if(!a.test($('#nurse_pay').val()) || $('#nurse_pay').val()=='') {
						layer.msg('请输入正确阿姨工资！');
						return false;
					}
					if(!reg.test($('#b_time').val())  ||  !reg.test($('#s_time').val())){
						layer.msg('请输入正确的预计上下户时间！');
						return false;
					}
					if(duibi($('#b_time').val(),$('#s_time').val())  == 1){
						layer.msg('下户时间比上户时间小！');
						return false;
					}
					$('#form_make_order').submit();
				});

//				上户
				function upOrder(){
					var submit = "javascript:return window.confirm('确定执行上户操作么？')";
					layer.open({
						type: 1,
						title: '上户操作',
						area: ['auto', 'auto'], //宽高
						content: '<div class="lay_cnt">'
						+   '<form action="__MODULE__/OrderShow/up_order" method="post" id="form_sub_up" class="form" onsubmit="'+submit+'"  enctype="multipart/form-data">'
						+	'<div class="opn_div clear">'
						+		'<label>实际上户日期：</label>'
						+		'<span>'
						+			'<input type="text"  class="form-control"  name="true_b_time" id="true_b_time" placeholder="2016-01-01"/>'
						+			'<input type="hidden"   name="id"  value="{$info.id}"/>'
						+		'</span>'
						+	'</div>'
						+	'<div class="btn_div clear">'
						+		'<button type="button" class="default_btn" id="sub_up">确认</button>'
						+		'<button type="button" class="default_btn" onclick="close_lay()">取消</button>'
						+	'</div>'
						+	'</form>'
						+'</div>'
					});
				}
//            提交上户
				$('#sub_up').live('click',function(){
					if(!reg.test($('#true_b_time').val()) || $('#true_b_time').val()==''){
						layer.msg('请输入正确上户时间！');
						return false;
					}
					$('#form_sub_up').submit();
				});

//				下户
				function downOrder(){
					var submit = "javascript:return window.confirm('确定执行下户操作么？')";
					layer.open({
						type: 1,
						title: '下户操作',
						area: ['auto', 'auto'], //宽高
						content: '<div class="lay_cnt">'
						+   '<form action="__MODULE__/OrderShow/down_order" method="post" id="form_sub_down" class="form" onsubmit="'+submit+'"  enctype="multipart/form-data">'
						+	'<div class="opn_div clear">'
						+		'<label>实际下户日期：</label>'
						+		'<span>'
						+			'<input type="text"  class="form-control"  name="true_s_time" id="true_s_time" placeholder="2016-01-01"/>'
						+			'<input type="hidden"   name="id"  value="{$info.id}" id="id"/>'
						+		'</span>'
						+	'</div>'
						+	'<div class="opn_div clear">'
						+		'<label>上单时长：</label>'
						+		'<span>'
						+			'<input type="number"  class="form-control"  name="do_time" id="do_time" />'
						+		'</span>'
						+	'</div>'
						+	'<div class="opn_div clear">'
						+		'<label>工资计算：</label>'
						+		'<span>'
						+			'<input type="text"  class="form-control"  name="old_nurse_pay" id="old_nurse_pay"  readonly/>'
						+		'</span>'
						+	'</div>'
						+	'<div class="btn_div clear">'
						+		'<button type="button" class="default_btn" id="sub_down">确认</button>'
						+		'<button type="button" class="default_btn" onclick="close_lay()">取消</button>'
						+	'</div>'
						+	'</form>'
						+'</div>'
					});
				}
//				提交下户
				$('#sub_down').live('click',function(){

					if(!reg.test($('#true_s_time').val()) || $('#true_s_time').val()==''){
						layer.msg('请输入正确下户时间！');
						return false;
					}
					if($('#do_time').val()=='' ){
						layer.msg('请输入正确的阿姨上户时长！');
						return false;
					}
					$('#form_sub_down').submit();
				});

				function close_lay(){
					layer.closeAll();
				}
				function duibi(a, b) {
					var arr = a.split("-");
					var starttime = new Date(arr[0], arr[1], arr[2]);
					var starttimes = starttime.getTime();

					var arrs = b.split("-");
					var lktime = new Date(arrs[0], arrs[1], arrs[2]);
					var lktimes = lktime.getTime();
					if (starttimes >= lktimes) {
						return 1;
					}else{
						return 2;
					}
				}


			</script>

			<!--main end-->
</body>

</html>
